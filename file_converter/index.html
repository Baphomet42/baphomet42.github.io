<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="/mc/style.css">
    <link rel="icon" type="image/x-icon" href="https://avatars.githubusercontent.com/u/71295013?v=4">
    <link rel="apple-touch-icon" href="https://avatars.githubusercontent.com/u/71295013?v=4">
    <title>File Converter | BaphomethLabs</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="/template/data-include.js"></script>
</head>
<body>
    <article>
        <div data-include="/mc/header" id="header"></div>

        <table class="card-table"><tr class="card-table-row">

            <td class="card-wrap-mid"><div class="card tooltip center">
                <p class="item-header">File Converter</p>
                <br>
                <p class="item-subtitle"><span class="error">WIP - Sometimes doesn't include all converted files in zip download. Proceed with caution</span></p>
            </div></td>

            <td class="card-wrap-full"><div class="card tooltip center">

                <table class="card-table">
                    <tr class="card-table-row">
                        <td class="card-wrap-third-left">
                            <label for="file-input">File(s):</label>
                        </td>
                        <td class="card-wrap-third-mid">
                            <input type="file" id="file-input" style="display: none;" multiple/>
                            <button class="button" onClick="openFile()" style="font-size:x-large">Open</button>
                        </td>
                        <td class="card-wrap-third-right">
                            <span id="file-label"></span>
                        </td>
                    </tr>
                    <tr class="card-table-row"><td class="card-wrap-full"><br/></td></tr>
                    <tr class="card-table-row">
                        <td class="card-wrap-third-left">
                            <select id="convert-mode" style="font-size:large">
                                <option value="png-to-jpg">PNG to JPG (70% Quality)</option>
                            </select>
                        </td>
                        <td class="card-wrap-third-mid">
                            <button class="button" onClick="submit()" style="font-size:x-large">Convert</button>
                        </td>
                        <td class="card-wrap-third-right">
                            <span id="button-label" class="error"></span>
                        </td>
                    </tr>
                </table>

                <br/>

            </div></td>

        </tr></table>

    </article>
    <div data-include="/template/footer" id="footer"></div>

    <script>
        var files = null

        function openFile() {
            document.getElementById('file-input').click()
        }

        document.getElementById('file-input').addEventListener('change', function(event) {
            files = event.target.files
            let valid = false

            if(files.length > 0) {
                valid = true
                for(let i=1; i<files.length; i++)
                    if(files[i].type != files[0].type)
                        valid = false
            }

            if(valid) {
                document.getElementById('file-label').innerHTML = 'Selected '+files.length+' files (Type: '+files[0].type+')'
            }
            else {
                document.getElementById('file-label').innerHTML = 'All files must be the same type'
                files = null
            }

        })

        async function submit() {
            let valid = false
            let lbl = ''
            let convertMode = document.getElementById('convert-mode').value

            if(files === null)
                lbl = 'No file(s) selected'
            else if(convertMode === 'png-to-jpg') {
                if(files[0].type === 'image/png')
                    valid = true
                else
                    lbl = 'File(s) must be PNG'
            }

            document.getElementById('button-label').innerHTML = lbl

            if(valid) {
                document.getElementById('button-label').innerHTML = 'Starting conversion...'

                if(convertMode === 'png-to-jpg') {
                    const zip = new JSZip()

                    for(let i=0; i<files.length; i++) {
                        const reader = new FileReader()

                        reader.onload = function(e) {
                            const img = new Image()

                            img.onload = function() {
                                const canvas = document.createElement('canvas')
                                const ctx = canvas.getContext('2d')
                                canvas.width = img.width
                                canvas.height = img.height
                                ctx.drawImage(img, 0, 0)
                                
                                canvas.toBlob(function(blob) {
                                    const fileName = files[i].name.replace('.png', '.jpg')
                                    zip.file(fileName, blob, { binary: true })
                                    document.getElementById('button-label').innerHTML = 'Converting file '+(i+1)+'/'+files.length

                                    if ((i+1) == files.length) {
                                        document.getElementById('button-label').innerHTML = 'Zipping files...'
                                        zip.generateAsync({ type: 'blob' }).then(function(content) {
                                            const a = document.createElement('a')
                                            a.href = URL.createObjectURL(content)
                                            a.download = 'file_converter_'+getTimestamp()+'.zip'
                                            document.body.appendChild(a)
                                            a.click()
                                            document.body.removeChild(a)
                                            document.getElementById('button-label').innerHTML = ''
                                        })
                                    }
                                }, 'image/jpeg', 0.7)
                            }

                            img.src = e.target.result
                        };

                        reader.readAsDataURL(files[i])
                    }
                }
            }
        }

        function getTimestamp() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0'); // Months are zero-indexed
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');

            return `${year}-${month}-${day}_${hours}.${minutes}.${seconds}`;
        }

    </script>

</body>
</html>